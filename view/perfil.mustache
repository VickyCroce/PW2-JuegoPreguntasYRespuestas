<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Perfil de {{nombre_completo}}</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>

<div class="w3-container w3-light-grey w3-card w3-round-large w3-margin-top w3-padding-large w3-center" style="max-width: 600px; margin: 0 auto;">
    <h1>Perfil de {{nombre_completo}}</h1>

    <div>
        <img class="w3-circle" src="{{foto_perfil}}" alt="Foto de perfil de {{nombre_completo}}" style="width: 150px; height: 150px; object-fit: cover;">
    </div>

    <div class="w3-padding-large">
        <p><strong>Nombre de Usuario:</strong> {{nombre_usuario}}</p>
        <p><strong>Año de Nacimiento:</strong> {{anio_nacimiento}}</p>
        <p><strong>Sexo:</strong> {{sexo}}</p>
        <p><strong>País:</strong> {{pais}}</p>
        <p><strong>Ciudad:</strong> {{ciudad}}</p>
        <p><strong>Email:</strong> {{email}}</p>
        <p><strong>Fecha de Registro:</strong> {{fecha_registro}}</p>
    </div>

    <h3>Mapa de ubicación</h3>
    <iframe
            width="100%"
            height="300"
            style="border:0"
            loading="lazy"
            allowfullscreen
            src="https://www.google.com/maps/embed/v1/place?key=TU_API_KEY&q={{ciudad}},{{pais}}">
    </iframe>

    <h3>Acceso rápido a este perfil</h3>
    <div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://tu_dominio.com/profile.php?user={{nombre_usuario}}" alt="Código QR para el perfil de {{nombre_usuario}}">
    </div>
    <div class="w3-margin-top">
        <a class="w3-button w3-teal w3-round" href="/ControllerHome/get">Volver al lobby</a>
    </div>

</div>

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>


    setCityAndCountry("{{usuarioLogeado.pais}}", "{{usuarioLogeado.ciudad}}");

    var map = L.map('map').setView([0,0], 10);
    var circle = L.circle([0,0], {
        color: '#00c6fb',
        fillColor: '#00c6fb',
        fillOpacity: 0.5,
        radius: 5000
    }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);


    // Función para obtener ciudad y país
    function getCityAndCountry(lat, lon) {
        let url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`;

        if(circle)
            map.removeLayer(circle);

        circle = L.circle([lat,lon], {
            color: '#00c6fb',
            fillColor: '#00c6fb',
            fillOpacity: 0.5,
            radius: 5000
        }).addTo(map);

        fetch(url)
                .then(response => response.json())
                .then(data => {
                    let city = data.address.city || data.address.town || data.address.village;
                    let country = data.address.country;

                    document.getElementById("pais").value= (country==undefined) ? "" : country;
                    document.getElementById("ciudad").value= (city==undefined) ? "" :city;

                })
                .catch(error => console.error('Error:', error));
    }


    function setCityAndCountry(pais, ciudad){
        let url = `https://nominatim.openstreetmap.org/search?q=${pais}+${ciudad}&format=json&limit=1`;

        fetch(url)
                .then(response=> response.json())
                .then(data =>{
                    let longitud = data[0].lon;
                    let latitud = data[0].lat;
                    if(circle)
                        map.removeLayer(circle);

                    map.setView([latitud, longitud], 10);
                    circle = L.circle([latitud,longitud], {
                        color: '#00c6fb',
                        fillColor: '#00c6fb',
                        fillOpacity: 0.5,
                        radius: 5000
                    }).addTo(map);
                })
                .catch(error => console.error('Error:', error));

    }

    // Evento de clic en el mapa para obtener ciudad y país
    map.on('click', function(e) {
        let lat = e.latlng.lat;
        let lon = e.latlng.lng;
        getCityAndCountry(lat, lon);
    });

    document.getElementById("ciudad").addEventListener("change", ()=>{
        setCityAndCountry(document.getElementById("pais").value, document.getElementById("ciudad").value);
    });


    document.getElementById("pais").addEventListener("change", ()=>{
        setCityAndCountry(document.getElementById("pais").value, document.getElementById("ciudad").value);
    });
</script>
</body>
</html>
